<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masjid Al-Barokah - Sistem Manajemen Terintegrasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-bg {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(16, 185, 129, 0.8)), 
                        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="mosque-pattern" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="1000" height="1000" fill="url(%23mosque-pattern)"/></svg>');
        }
        .prayer-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .floating-card {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .connection-status {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-connected {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-disconnected {
            background-color: #fef2f2;
            color: #dc2626;
        }
        .status-connecting {
            background-color: #fef3c7;
            color: #d97706;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        .debug-panel.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold">Debug Console</span>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">×</button>
        </div>
        <div id="debugContent"></div>
    </div>

    <!-- Database Configuration Modal -->
    <div id="dbConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-database text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Konfigurasi Database Google Sheets</h2>
                <p class="text-gray-600">Hubungkan aplikasi dengan Google Sheets Anda</p>
            </div>

            <!-- Connection Status -->
            <div class="mb-6 text-center">
                <div id="connectionStatus" class="connection-status status-disconnected">
                    <i class="fas fa-times-circle mr-2"></i>
                    <span>Belum Terhubung</span>
                </div>
            </div>

            <!-- Configuration Tabs -->
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button onclick="showConfigTab('setup')" class="config-tab-btn px-6 py-3 border-b-2 border-emerald-500 text-emerald-600 font-medium">
                        Setup Manual
                    </button>
                    <button onclick="showConfigTab('auto')" class="config-tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Auto Setup
                    </button>
                    <button onclick="showConfigTab('demo')" class="config-tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Mode Demo
                    </button>
                </div>
            </div>

            <!-- Manual Setup Tab -->
            <div id="setupTab" class="config-tab">
                <form id="dbConfigForm" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheets ID *</label>
                            <input type="text" id="spreadsheetId" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                            <p class="text-xs text-gray-500 mt-1">Dari URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheets API Key *</label>
                            <div class="relative">
                                <input type="password" id="apiKey" required class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="AIzaSyD...">
                                <button type="button" onclick="toggleApiKeyVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i id="apiKeyToggleIcon" class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">API Key dari Google Cloud Console</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="font-semibold text-blue-800 mb-4 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>Panduan Setup Lengkap
                        </h4>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-sm text-blue-700">
                            <div>
                                <div class="font-medium mb-2">1. Buat Google Sheets:</div>
                                <ul class="list-disc list-inside ml-4 space-y-1 text-xs">
                                    <li>Buka <a href="https://sheets.google.com" target="_blank" class="underline font-medium">Google Sheets</a></li>
                                    <li>Buat spreadsheet baru</li>
                                    <li>Rename menjadi "Masjid Database"</li>
                                    <li>Buat 6 sheet: income, expenses, members, activities, articles, donations</li>
                                </ul>
                                
                                <div class="font-medium mt-4 mb-2">2. Setup Sharing:</div>
                                <ul class="list-disc list-inside ml-4 space-y-1 text-xs">
                                    <li>Klik "Share" → "Change to anyone with the link"</li>
                                    <li>Set permission ke "Viewer" atau "Editor"</li>
                                    <li>Copy Spreadsheet ID dari URL</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="font-medium mb-2">3. Dapatkan API Key:</div>
                                <ul class="list-disc list-inside ml-4 space-y-1 text-xs">
                                    <li>Buka <a href="https://console.cloud.google.com" target="_blank" class="underline font-medium">Google Cloud Console</a></li>
                                    <li>Buat project baru atau pilih existing</li>
                                    <li>Enable "Google Sheets API"</li>
                                    <li>Credentials → Create → API Key</li>
                                    <li>Restrict API key untuk Sheets API saja</li>
                                </ul>
                                
                                <div class="font-medium mt-4 mb-2">4. Troubleshooting:</div>
                                <ul class="list-disc list-inside ml-4 space-y-1 text-xs">
                                    <li>Pastikan Sheets API enabled</li>
                                    <li>Cek quota limits di Cloud Console</li>
                                    <li>Pastikan spreadsheet public/shared</li>
                                    <li>Gunakan debug panel untuk detail error</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="testConnection()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-plug mr-2"></i>Test Koneksi
                        </button>
                        <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-save mr-2"></i>Simpan & Lanjutkan
                        </button>
                    </div>
                </form>
            </div>

            <!-- Auto Setup Tab -->
            <div id="autoTab" class="config-tab hidden">
                <div class="text-center space-y-6">
                    <div class="bg-gradient-to-r from-emerald-500 to-blue-600 text-white p-8 rounded-xl">
                        <i class="fas fa-magic text-4xl mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2">Auto Setup (Coming Soon)</h3>
                        <p class="text-emerald-100">Fitur untuk membuat spreadsheet otomatis dengan Google Apps Script</p>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h4 class="font-semibold text-yellow-800 mb-3">Sementara gunakan setup manual:</h4>
                        <ol class="text-sm text-yellow-700 space-y-2 text-left">
                            <li>1. Copy template spreadsheet dari link di bawah</li>
                            <li>2. Buat API Key di Google Cloud Console</li>
                            <li>3. Masukkan ID dan API Key di tab "Setup Manual"</li>
                        </ol>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="copyTemplateSpreadsheet()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-copy mr-2"></i>Copy Template Spreadsheet
                        </button>
                        <button onclick="showConfigTab('setup')" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Setup Manual
                        </button>
                    </div>
                </div>
            </div>

            <!-- Demo Mode Tab -->
            <div id="demoTab" class="config-tab hidden">
                <div class="text-center space-y-6">
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-600 text-white p-8 rounded-xl">
                        <i class="fas fa-play-circle text-4xl mb-4"></i>
                        <h3 class="text-2xl font-bold mb-2">Mode Demo</h3>
                        <p class="text-yellow-100">Coba aplikasi dengan data contoh tanpa perlu Google Sheets</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="font-semibold text-blue-800 mb-3">Fitur Mode Demo:</h4>
                        <ul class="text-sm text-blue-700 space-y-2">
                            <li>✅ Data contoh lengkap (pemasukan, pengeluaran, donasi, jamaah)</li>
                            <li>✅ Semua fitur admin panel berfungsi</li>
                            <li>✅ Form input dan laporan real-time</li>
                            <li>⚠️ Data tidak tersimpan permanen</li>
                            <li>⚠️ Reset setiap refresh halaman</li>
                        </ul>
                    </div>
                    
                    <button onclick="useDemoMode()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-12 py-4 rounded-lg text-lg font-semibold transition-colors">
                        <i class="fas fa-play mr-3"></i>Mulai Mode Demo
                    </button>
                </div>
            </div>

            <!-- Debug Toggle -->
            <div class="mt-6 text-center">
                <button onclick="toggleDebug()" class="text-gray-500 hover:text-gray-700 text-sm">
                    <i class="fas fa-bug mr-1"></i>Toggle Debug Panel
                </button>
            </div>
        </div>
    </div>

    <!-- Public Homepage -->
    <div id="publicHomepage" class="hidden">
        <!-- Navigation Header -->
        <nav class="bg-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-mosque text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Masjid Al-Barokah</h1>
                            <p class="text-xs text-gray-600">Jl. Raya Bogor No. 123, Jakarta</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <!-- Database Status Indicator -->
                        <div id="navDbStatus" class="connection-status status-connected text-xs">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>Database Terhubung</span>
                        </div>
                        <a href="#beranda" class="text-gray-700 hover:text-emerald-600 transition-colors">Beranda</a>
                        <a href="#kegiatan" class="text-gray-700 hover:text-emerald-600 transition-colors">Kegiatan</a>
                        <a href="#donasi" class="text-gray-700 hover:text-emerald-600 transition-colors">Donasi</a>
                        <button onclick="showLoginModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login Admin
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section id="beranda" class="hero-bg min-h-screen flex items-center">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                    <div class="text-white">
                        <h1 class="text-5xl font-bold mb-6">Selamat Datang di<br>Masjid Al-Barokah</h1>
                        <p class="text-xl mb-8 text-emerald-100">Sistem manajemen masjid terintegrasi dengan Google Sheets untuk transparansi dan kemudahan pengelolaan data keuangan.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="scrollToSection('kegiatan')" class="bg-white text-emerald-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                                <i class="fas fa-calendar mr-2"></i>Lihat Kegiatan
                            </button>
                            <button onclick="showDonationForm()" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-emerald-600 transition-colors">
                                <i class="fas fa-heart mr-2"></i>Donasi Sekarang
                            </button>
                        </div>
                    </div>
                    
                    <!-- Prayer Times Card -->
                    <div class="floating-card">
                        <div class="prayer-card rounded-2xl p-8 shadow-2xl">
                            <div class="text-center mb-6">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Jadwal Sholat Hari Ini</h3>
                                <p class="text-gray-600" id="currentDate">Loading...</p>
                                <p class="text-sm text-gray-500" id="currentLocation">Jakarta, Indonesia</p>
                            </div>
                            
                            <div class="space-y-4" id="prayerTimes">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <div class="animate-pulse bg-gray-300 h-4 w-16 rounded"></div>
                                    <div class="animate-pulse bg-gray-300 h-4 w-12 rounded"></div>
                                </div>
                            </div>
                            
                            <div class="mt-6 text-center">
                                <div class="bg-emerald-50 rounded-lg p-4">
                                    <p class="text-sm text-emerald-700 mb-1">Sholat Berikutnya:</p>
                                    <p class="text-lg font-bold text-emerald-800" id="nextPrayer">Loading...</p>
                                    <p class="text-sm text-emerald-600" id="timeUntilNext">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Real-time Stats from Spreadsheet -->
        <section class="py-16 bg-white">
            <div class="container mx-auto px-4">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Data Real-time dari Google Sheets</h2>
                    <p class="text-gray-600">Data keuangan diperbarui secara otomatis dan transparan</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-users text-2xl text-emerald-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2" id="totalJamaah">Loading...</h3>
                        <p class="text-gray-600">Jamaah Terdaftar</p>
                        <p class="text-xs text-gray-500 mt-1">Update: <span id="jamaahLastUpdate">-</span></p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2" id="totalActivities">Loading...</h3>
                        <p class="text-gray-600">Kegiatan Aktif</p>
                        <p class="text-xs text-gray-500 mt-1">Update: <span id="activitiesLastUpdate">-</span></p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-hand-holding-heart text-2xl text-yellow-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2" id="totalDonations">Loading...</h3>
                        <p class="text-gray-600">Total Donasi</p>
                        <p class="text-xs text-gray-500 mt-1">Update: <span id="donationsLastUpdate">-</span></p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-wallet text-2xl text-purple-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2" id="currentBalance">Loading...</h3>
                        <p class="text-gray-600">Saldo Kas</p>
                        <p class="text-xs text-gray-500 mt-1">Update: <span id="balanceLastUpdate">-</span></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activities Section -->
        <section id="kegiatan" class="py-16 bg-gray-50">
            <div class="container mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-800 mb-4">Kegiatan Masjid</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">Kegiatan dan program masjid yang dikelola secara transparan</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="activitiesList">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">Memuat data kegiatan...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Donation Section -->
        <section id="donasi" class="py-16 bg-emerald-50">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-4xl font-bold text-gray-800 mb-4">Donasi Transparan</h2>
                    <p class="text-gray-600 mb-12 max-w-2xl mx-auto">Setiap donasi langsung tercatat di Google Sheets untuk transparansi penuh kepada jamaah</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-8 rounded-2xl">
                            <i class="fas fa-mosque text-4xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">Operasional Masjid</h3>
                            <p class="text-emerald-100">Listrik, air, kebersihan, dan kebutuhan harian masjid</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-8 rounded-2xl">
                            <i class="fas fa-hammer text-4xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">Pembangunan</h3>
                            <p class="text-blue-100">Renovasi dan pengembangan fasilitas masjid</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-8 rounded-2xl">
                            <i class="fas fa-hands-helping text-4xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">Program Sosial</h3>
                            <p class="text-purple-100">Bantuan untuk fakir miskin dan yatim piatu</p>
                        </div>
                    </div>
                    
                    <button onclick="showDonationForm()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-12 py-4 rounded-lg text-lg font-semibold transition-colors">
                        <i class="fas fa-heart mr-3"></i>Donasi Sekarang
                    </button>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-12">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-mosque text-white"></i>
                            </div>
                            <h3 class="text-xl font-bold">Masjid Al-Barokah</h3>
                        </div>
                        <p class="text-gray-400 mb-4">Sistem manajemen masjid terintegrasi dengan Google Sheets untuk transparansi penuh.</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Kontak</h4>
                        <div class="space-y-2 text-gray-400">
                            <p><i class="fas fa-map-marker-alt mr-2"></i>Jl. Raya Bogor No. 123, Jakarta</p>
                            <p><i class="fas fa-phone mr-2"></i>(021) 1234-5678</p>
                            <p><i class="fas fa-envelope mr-2"></i>info@albarokah.id</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Jadwal Sholat</h4>
                        <div class="space-y-1 text-gray-400 text-sm" id="footerPrayerTimes">
                            <!-- Prayer times will be loaded here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Transparansi</h4>
                        <div class="space-y-2 text-gray-400 text-sm">
                            <p><i class="fas fa-table mr-2"></i>Data Real-time</p>
                            <p><i class="fas fa-eye mr-2"></i>Laporan Transparan</p>
                            <p><i class="fas fa-shield-alt mr-2"></i>Audit Trail</p>
                            <button onclick="showSpreadsheetLink()" class="text-emerald-400 hover:text-emerald-300 text-sm">
                                <i class="fas fa-external-link-alt mr-1"></i>Lihat Google Sheets
                            </button>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                    <p>&copy; 2024 Masjid Al-Barokah. Powered by Google Sheets Integration.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Admin Header -->
        <header class="bg-emerald-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-mosque text-3xl"></i>
                        <div>
                            <h1 class="text-2xl font-bold">Admin Panel - Masjid Al-Barokah</h1>
                            <p class="text-emerald-200 text-sm">Terintegrasi dengan Google Sheets</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="adminDbStatus" class="connection-status status-connected text-xs">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>Spreadsheet Terhubung</span>
                        </div>
                        <div class="text-right">
                            <p class="text-emerald-200 text-sm" id="userRole">Admin</p>
                            <p class="font-semibold" id="userName">Ahmad Fauzi</p>
                        </div>
                        <button onclick="logout()" class="bg-emerald-700 hover:bg-emerald-600 px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Navigation -->
        <nav class="bg-emerald-700 text-white">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto">
                    <button onclick="showAdminSection('dashboard')" class="admin-nav-btn px-6 py-3 hover:bg-emerald-600 transition-colors whitespace-nowrap active bg-emerald-600">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="showAdminSection('income')" class="admin-nav-btn px-6 py-3 hover:bg-emerald-600 transition-colors whitespace-nowrap">
                        <i class="fas fa-arrow-up mr-2"></i>Pemasukan
                    </button>
                    <button onclick="showAdminSection('expense')" class="admin-nav-btn px-6 py-3 hover:bg-emerald-600 transition-colors whitespace-nowrap">
                        <i class="fas fa-arrow-down mr-2"></i>Pengeluaran
                    </button>
                    <button onclick="showAdminSection('donations')" class="admin-nav-btn px-6 py-3 hover:bg-emerald-600 transition-colors whitespace-nowrap">
                        <i class="fas fa-heart mr-2"></i>Donasi
                    </button>
                    <button onclick="showAdminSection('sync')" class="admin-nav-btn px-6 py-3 hover:bg-emerald-600 transition-colors whitespace-nowrap">
                        <i class="fas fa-sync mr-2"></i>Sinkronisasi
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-6">
            <!-- Dashboard Section -->
            <div id="dashboard" class="admin-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Saldo Kas</p>
                                <p class="text-2xl font-bold text-emerald-600" id="dashboardBalance">Loading...</p>
                            </div>
                            <i class="fas fa-wallet text-3xl text-emerald-600"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Update: <span id="balanceSheetUpdate">-</span></p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Pemasukan Bulan Ini</p>
                                <p class="text-2xl font-bold text-green-600" id="dashboardIncome">Loading...</p>
                            </div>
                            <i class="fas fa-arrow-up text-3xl text-green-600"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Update: <span id="incomeSheetUpdate">-</span></p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Pengeluaran Bulan Ini</p>
                                <p class="text-2xl font-bold text-red-600" id="dashboardExpense">Loading...</p>
                            </div>
                            <i class="fas fa-arrow-down text-3xl text-red-600"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Update: <span id="expenseSheetUpdate">-</span></p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Jamaah Terdaftar</p>
                                <p class="text-2xl font-bold text-blue-600" id="dashboardMembers">Loading...</p>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-600"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Update: <span id="membersSheetUpdate">-</span></p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold mb-4">Aksi Cepat</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <button onclick="showAddIncomeModal()" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors">
                            <i class="fas fa-plus-circle text-2xl mb-2"></i>
                            <p class="font-semibold">Tambah Pemasukan</p>
                        </button>
                        <button onclick="showAddExpenseModal()" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg transition-colors">
                            <i class="fas fa-minus-circle text-2xl mb-2"></i>
                            <p class="font-semibold">Tambah Pengeluaran</p>
                        </button>
                        <button onclick="syncAllSheets()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg transition-colors">
                            <i class="fas fa-sync text-2xl mb-2"></i>
                            <p class="font-semibold">Sinkronkan Data</p>
                        </button>
                        <button onclick="openSpreadsheet()" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg transition-colors">
                            <i class="fas fa-external-link-alt text-2xl mb-2"></i>
                            <p class="font-semibold">Buka Spreadsheet</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Income Management -->
            <div id="income" class="admin-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold">Manajemen Pemasukan</h3>
                            <p class="text-gray-600 text-sm">Data tersinkronisasi dengan Google Sheets</p>
                        </div>
                        <button onclick="showAddIncomeModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Tambah Pemasukan
                        </button>
                    </div>

                    <!-- Income List -->
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sumber</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="incomeTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto mb-2"></div>
                                        Memuat data dari Google Sheets...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expense Management -->
            <div id="expense" class="admin-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold">Manajemen Pengeluaran</h3>
                            <p class="text-gray-600 text-sm">Data tersinkronisasi dengan Google Sheets</p>
                        </div>
                        <button onclick="showAddExpenseModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Tambah Pengeluaran
                        </button>
                    </div>

                    <!-- Expense List -->
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penerima</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto mb-2"></div>
                                        Memuat data dari Google Sheets...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Donations Management -->
            <div id="donations" class="admin-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold">Manajemen Donasi</h3>
                            <p class="text-gray-600 text-sm">Donasi dari form publik tersimpan otomatis</p>
                        </div>
                        <button onclick="refreshDonations()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-refresh mr-2"></i>Refresh Data
                        </button>
                    </div>

                    <!-- Donations List -->
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="donationsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto mb-2"></div>
                                        Memuat data donasi...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sync Management -->
            <div id="sync" class="admin-section hidden">
                <div class="space-y-6">
                    <!-- Sync Status -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Status Sinkronisasi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Pemasukan</p>
                                    <p class="text-xs text-gray-500" id="incomeSyncStatus">Belum disinkronkan</p>
                                </div>
                                <button onclick="syncSheet('income')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Pengeluaran</p>
                                    <p class="text-xs text-gray-500" id="expenseSyncStatus">Belum disinkronkan</p>
                                </div>
                                <button onclick="syncSheet('expenses')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Donasi</p>
                                    <p class="text-xs text-gray-500" id="donationsSyncStatus">Belum disinkronkan</p>
                                </div>
                                <button onclick="syncSheet('donations')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Jamaah</p>
                                    <p class="text-xs text-gray-500" id="membersSyncStatus">Belum disinkronkan</p>
                                </div>
                                <button onclick="syncSheet('members')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button onclick="syncAllSheets()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sync mr-2"></i>Sinkronkan Semua
                            </button>
                        </div>
                    </div>

                    <!-- Sync History -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Riwayat Sinkronisasi</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sheet</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Error</th>
                                    </tr>
                                </thead>
                                <tbody id="syncHistoryBody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada riwayat sinkronisasi</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-mosque text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Login Admin</h2>
                <p class="text-gray-600">Masuk ke panel administrasi</p>
            </div>
            
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Masukkan password">
                </div>
                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-2">Demo Login:</p>
                <div class="text-xs text-gray-600 space-y-1">
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>Bendahara:</strong> bendahara / bendahara123</p>
                </div>
            </div>
            
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Donation Form Modal -->
    <div id="donationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-heart text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Form Donasi</h2>
                <p class="text-gray-600">Donasi akan langsung tercatat di Google Sheets</p>
            </div>
            
            <form id="donationForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="donorName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Nama lengkap Anda">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon *</label>
                        <input type="tel" id="donorPhone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="08xxxxxxxxxx">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Donasi *</label>
                    <select id="donationType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Pilih jenis donasi</option>
                        <option value="Donasi Umum">Donasi Umum</option>
                        <option value="Operasional Masjid">Operasional Masjid</option>
                        <option value="Pembangunan Masjid">Pembangunan Masjid</option>
                        <option value="Program Sosial">Program Sosial</option>
                        <option value="Zakat Fitrah">Zakat Fitrah</option>
                        <option value="Zakat Mal">Zakat Mal</option>
                        <option value="Infaq">Infaq</option>
                        <option value="Sedekah">Sedekah</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Donasi *</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                        <input type="number" id="donationAmount" required min="10000" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="50000">
                    </div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button type="button" onclick="setDonationAmount(50000)" class="px-3 py-1 text-sm bg-gray-100 hover:bg-emerald-100 rounded-lg transition-colors">50rb</button>
                        <button type="button" onclick="setDonationAmount(100000)" class="px-3 py-1 text-sm bg-gray-100 hover:bg-emerald-100 rounded-lg transition-colors">100rb</button>
                        <button type="button" onclick="setDonationAmount(250000)" class="px-3 py-1 text-sm bg-gray-100 hover:bg-emerald-100 rounded-lg transition-colors">250rb</button>
                        <button type="button" onclick="setDonationAmount(500000)" class="px-3 py-1 text-sm bg-gray-100 hover:bg-emerald-100 rounded-lg transition-colors">500rb</button>
                        <button type="button" onclick="setDonationAmount(1000000)" class="px-3 py-1 text-sm bg-gray-100 hover:bg-emerald-100 rounded-lg transition-colors">1jt</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran *</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="Transfer Bank" class="mr-3">
                            <div class="flex items-center">
                                <i class="fas fa-university text-green-600 mr-2"></i>
                                <span>Transfer Bank</span>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="QRIS" class="mr-3">
                            <div class="flex items-center">
                                <i class="fas fa-qrcode text-blue-600 mr-2"></i>
                                <span>QRIS</span>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="Tunai" class="mr-3">
                            <div class="flex items-center">
                                <i class="fas fa-money-bill-wave text-yellow-600 mr-2"></i>
                                <span>Tunai</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pesan (Opsional)</label>
                    <textarea id="donationMessage" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Pesan atau doa untuk masjid..."></textarea>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" onclick="closeDonationModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-heart mr-2"></i>Donasi Sekarang
                    </button>
                </div>
            </form>
            
            <button onclick="closeDonationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div id="addIncomeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-arrow-up text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Tambah Pemasukan</h2>
                <p class="text-gray-600">Data akan disimpan ke Google Sheets</p>
            </div>
            
            <form id="addIncomeForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal *</label>
                    <input type="date" id="incomeDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                    <select id="incomeCategory" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <option value="">Pilih kategori</option>
                        <option value="Donasi Umum">Donasi Umum</option>
                        <option value="Zakat">Zakat</option>
                        <option value="Infaq">Infaq</option>
                        <option value="Sedekah">Sedekah</option>
                        <option value="Sewa Fasilitas">Sewa Fasilitas</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah *</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                        <input type="number" id="incomeAmount" required min="1000" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="100000">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sumber *</label>
                    <input type="text" id="incomeSource" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Nama donatur atau sumber">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="incomeDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Keterangan tambahan..."></textarea>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeAddIncomeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-save mr-2"></i>Simpan ke Sheets
                    </button>
                </div>
            </form>
            
            <button onclick="closeAddIncomeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-arrow-down text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Tambah Pengeluaran</h2>
                <p class="text-gray-600">Data akan disimpan ke Google Sheets</p>
            </div>
            
            <form id="addExpenseForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal *</label>
                    <input type="date" id="expenseDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                    <select id="expenseCategory" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="">Pilih kategori</option>
                        <option value="Operasional">Operasional</option>
                        <option value="Listrik & Air">Listrik & Air</option>
                        <option value="Kebersihan">Kebersihan</option>
                        <option value="Pemeliharaan">Pemeliharaan</option>
                        <option value="Kegiatan">Kegiatan</option>
                        <option value="Bantuan Sosial">Bantuan Sosial</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah *</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                        <input type="number" id="expenseAmount" required min="1000" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="100000">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Penerima *</label>
                    <input type="text" id="expenseRecipient" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Nama penerima atau vendor">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                    <textarea id="expenseDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Keterangan tambahan..."></textarea>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" onclick="closeAddExpenseModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-save mr-2"></i>Simpan ke Sheets
                    </button>
                </div>
            </form>
            
            <button onclick="closeAddExpenseModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-emerald-600"></div>
            <span class="text-gray-700" id="loadingMessage">Memproses...</span>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-800">Berhasil!</h3>
            </div>
            <p id="successMessage" class="text-gray-600 mb-4"></p>
            <button onclick="closeSuccessModal()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
                OK
            </button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-800">Error</h3>
            </div>
            <p id="errorMessage" class="text-gray-600 mb-4"></p>
            <div class="flex space-x-2">
                <button onclick="closeErrorModal()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors">
                    Tutup
                </button>
                <button onclick="copyErrorToClipboard()" class="px-4 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition-colors">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let prayerTimes = {};
        let nextPrayerInterval = null;
        let dbConfig = {
            spreadsheetId: '',
            apiKey: '',
            isConnected: false,
            isDemoMode: false
        };
        let syncHistory = [];
        let debugLogs = [];

        // Google Sheets API configuration
        const SHEETS_API_BASE = 'https://sheets.googleapis.com/v4/spreadsheets';
        
        // Required sheet structure
        const REQUIRED_SHEETS = {
            'income': ['Tanggal', 'Kategori', 'Jumlah', 'Sumber', 'Deskripsi', 'Timestamp', 'Status'],
            'expenses': ['Tanggal', 'Kategori', 'Jumlah', 'Penerima', 'Deskripsi', 'Timestamp', 'Status'],
            'members': ['Nama', 'Telepon', 'Email', 'Alamat', 'Kategori', 'Status', 'Bergabung', 'Catatan'],
            'activities': ['Judul', 'Deskripsi', 'Tanggal', 'Waktu', 'Lokasi', 'Pembicara', 'Kategori', 'Status'],
            'articles': ['Judul', 'Konten', 'Ringkasan', 'Penulis', 'Kategori', 'Status', 'Dipublikasi'],
            'donations': ['ID', 'Nama', 'Telepon', 'Jenis', 'Jumlah', 'Pesan', 'Metode', 'Status', 'Waktu']
        };

        // Demo data for fallback
        let demoData = {
            income: [
                ['2024-12-01', 'Donasi Umum', 2500000, 'Jamaah Jumat', 'Donasi kotak amal', new Date().toISOString(), 'Verified'],
                ['2024-12-05', 'Zakat', 5000000, 'H. Abdullah', 'Zakat mal 2024', new Date().toISOString(), 'Verified'],
                ['2024-12-10', 'Infaq', 1500000, 'Keluarga Budi', 'Infaq bulanan', new Date().toISOString(), 'Verified'],
                ['2024-12-15', 'Sedekah', 750000, 'Anonim', 'Sedekah Jumat', new Date().toISOString(), 'Verified']
            ],
            expenses: [
                ['2024-12-02', 'Listrik & Air', 850000, 'PLN & PDAM', 'Tagihan November', new Date().toISOString(), 'Paid'],
                ['2024-12-07', 'Kebersihan', 300000, 'Toko Sinar Jaya', 'Alat kebersihan', new Date().toISOString(), 'Paid'],
                ['2024-12-12', 'Bantuan Sosial', 2000000, 'Yatim Piatu', 'Bantuan bulanan', new Date().toISOString(), 'Paid'],
                ['2024-12-18', 'Pemeliharaan', 500000, 'Tukang Listrik', 'Perbaikan lampu', new Date().toISOString(), 'Paid']
            ],
            members: [
                ['Ahmad Fauzi', '081234567890', 'ahmad@email.com', 'Jl. Mawar 15', 'Pengurus', 'Active', '2020-01-15', 'Ketua Takmir'],
                ['Siti Aminah', '081234567891', 'siti@email.com', 'Jl. Melati 22', 'Pengurus', 'Active', '2020-02-01', 'Bendahara'],
                ['Muhammad Rizki', '081234567892', 'rizki@email.com', 'Jl. Anggrek 8', 'Jamaah Umum', 'Active', '2021-03-10', 'Jamaah aktif'],
                ['Fatimah Zahra', '081234567893', 'fatimah@email.com', 'Jl. Dahlia 5', 'Jamaah Umum', 'Active', '2021-06-20', 'Jamaah aktif'],
                ['Usman bin Affan', '081234567894', 'usman@email.com', 'Jl. Kenanga 12', 'Pengurus', 'Active', '2020-03-15', 'Sekretaris']
            ],
            activities: [
                ['Kajian Rutin Ahad', 'Kajian setiap Ahad pagi setelah sholat Subuh', '2024-12-22', '06:30', 'Masjid Al-Barokah', 'Ustadz Ahmad Fauzi', 'Kajian', 'Active'],
                ['Bakti Sosial', 'Pembagian sembako untuk fakir miskin', '2024-12-25', '08:00', 'Halaman Masjid', 'Panitia Sosial', 'Sosial', 'Active'],
                ['Pengajian Ibu-ibu', 'Pengajian rutin untuk jamaah wanita', '2024-12-20', '14:00', 'Ruang Serbaguna', 'Ustadzah Siti', 'Kajian', 'Active']
            ],
            donations: [
                ['DN1734234567', 'Ahmad Santoso', '081234567890', 'Donasi Umum', 500000, 'Semoga bermanfaat untuk masjid', 'QRIS', 'Verified', new Date().toISOString()],
                ['DN1734234568', 'Siti Nurhaliza', '081234567891', 'Pembangunan Masjid', 1000000, 'Untuk renovasi masjid', 'Transfer Bank', 'Verified', new Date().toISOString()],
                ['DN1734234569', 'Budi Hartono', '081234567892', 'Program Sosial', 750000, 'Bantuan untuk yatim piatu', 'Tunai', 'Pending', new Date().toISOString()],
                ['DN1734234570', 'Anonim', '-', 'Operasional Masjid', 250000, 'Semoga berkah', 'QRIS', 'Verified', new Date().toISOString()]
            ]
        };

        // Debug Functions
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            debugLogs.unshift(logEntry);
            if (debugLogs.length > 50) {
                debugLogs = debugLogs.slice(0, 50);
            }
            
            updateDebugPanel();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function updateDebugPanel() {
            const debugContent = document.getElementById('debugContent');
            if (!debugContent) return;
            
            debugContent.innerHTML = debugLogs.map(log => {
                const colorClass = {
                    'error': 'text-red-400',
                    'warning': 'text-yellow-400',
                    'success': 'text-green-400',
                    'info': 'text-blue-400'
                }[log.type] || 'text-white';
                
                return `<div class="mb-1"><span class="text-gray-400">[${log.time}]</span> <span class="${colorClass}">${log.message}</span></div>`;
            }).join('');
        }

        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('hidden');
        }

        function copyErrorToClipboard() {
            const errorMessage = document.getElementById('errorMessage').textContent;
            navigator.clipboard.writeText(errorMessage).then(() => {
                showSuccess('Error message copied to clipboard');
            });
        }

        // Utility functions
        function showLoading(message = 'Memproses...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            addDebugLog(`Loading: ${message}`);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
            addDebugLog(message, 'error');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
            addDebugLog(message, 'success');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.getElementById('apiKeyToggleIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Configuration Tab Functions
        function showConfigTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.config-tab-btn').forEach(btn => {
                btn.classList.remove('border-emerald-500', 'text-emerald-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Activate button
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-emerald-500', 'text-emerald-600');
        }

        // Database Configuration Functions
        function useDemoMode() {
            dbConfig.isDemoMode = true;
            dbConfig.isConnected = true;
            updateConnectionStatus('connected', 'Mode Demo Aktif');
            closeDbConfigModal();
            initializeApp();
            addDebugLog('Demo mode activated', 'success');
        }

        function copyTemplateSpreadsheet() {
            const templateUrl = 'https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/copy';
            window.open(templateUrl, '_blank');
            showSuccess('Template spreadsheet akan terbuka di tab baru. Setelah copy, ambil ID dari URL dan masukkan di setup manual.');
        }

        async function testConnection() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!spreadsheetId || !apiKey) {
                showError('Harap isi Spreadsheet ID dan API Key');
                return;
            }

            showLoading('Menguji koneksi ke Google Sheets...');
            updateConnectionStatus('connecting', 'Menguji Koneksi...');
            addDebugLog(`Testing connection to spreadsheet: ${spreadsheetId.substring(0, 10)}...`);

            try {
                // Test basic access
                const testUrl = `${SHEETS_API_BASE}/${spreadsheetId}?key=${apiKey}`;
                addDebugLog(`Making request to: ${testUrl}`);
                
                const response = await fetch(testUrl);
                addDebugLog(`Response status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addDebugLog(`Spreadsheet title: ${data.properties.title}`);
                    
                    // Test reading a sheet
                    try {
                        const readUrl = `${SHEETS_API_BASE}/${spreadsheetId}/values/Sheet1?key=${apiKey}`;
                        const readResponse = await fetch(readUrl);
                        addDebugLog(`Read test status: ${readResponse.status}`);
                        
                        if (readResponse.ok) {
                            const readData = await readResponse.json();
                            addDebugLog(`Read test successful, rows: ${readData.values ? readData.values.length : 0}`);
                        }
                    } catch (readError) {
                        addDebugLog(`Read test failed: ${readError.message}`, 'warning');
                    }
                    
                    hideLoading();
                    updateConnectionStatus('connected', 'Koneksi Berhasil');
                    showSuccess(`Koneksi berhasil! Spreadsheet: "${data.properties.title}"`);
                } else {
                    const errorData = await response.json();
                    const errorMsg = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    addDebugLog(`Connection failed: ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
            } catch (error) {
                hideLoading();
                updateConnectionStatus('disconnected', 'Koneksi Gagal');
                addDebugLog(`Connection error: ${error.message}`, 'error');
                
                let errorMessage = `Koneksi gagal: ${error.message}`;
                
                // Add helpful troubleshooting tips
                if (error.message.includes('403')) {
                    errorMessage += '\n\nTips: Pastikan API Key valid dan Sheets API sudah diaktifkan di Google Cloud Console.';
                } else if (error.message.includes('404')) {
                    errorMessage += '\n\nTips: Periksa Spreadsheet ID dan pastikan spreadsheet dapat diakses publik.';
                } else if (error.message.includes('CORS')) {
                    errorMessage += '\n\nTips: Ini adalah masalah CORS. Coba gunakan mode demo atau akses dari server.';
                }
                
                showError(errorMessage);
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElements = ['connectionStatus', 'navDbStatus', 'adminDbStatus'];
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `connection-status status-${status}`;
                    
                    let icon = 'fas fa-times-circle';
                    if (status === 'connected') icon = 'fas fa-check-circle';
                    else if (status === 'connecting') icon = 'fas fa-spinner fa-spin';
                    
                    element.innerHTML = `<i class="${icon} mr-2"></i><span>${message}</span>`;
                }
            });
        }

        function closeDbConfigModal() {
            document.getElementById('dbConfigModal').classList.add('hidden');
        }

        function showDbConfigModal() {
            document.getElementById('dbConfigModal').classList.remove('hidden');
        }

        // Google Sheets API Functions with robust error handling
        async function readSheet(sheetName, range = '') {
            if (dbConfig.isDemoMode) {
                addDebugLog(`Reading demo data for ${sheetName}`);
                return demoData[sheetName] || [];
            }

            if (!dbConfig.isConnected) {
                throw new Error('Database tidak terhubung');
            }

            const fullRange = range ? `${sheetName}!${range}` : sheetName;
            const url = `${SHEETS_API_BASE}/${dbConfig.spreadsheetId}/values/${encodeURIComponent(fullRange)}?key=${dbConfig.apiKey}`;
            
            addDebugLog(`Reading sheet: ${sheetName}, URL: ${url}`);
            
            try {
                const response = await fetch(url);
                addDebugLog(`Read response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.error?.message || `Gagal membaca sheet: ${response.statusText}`;
                    addDebugLog(`Read error: ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                const rows = data.values || [];
                addDebugLog(`Successfully read ${rows.length} rows from ${sheetName}`, 'success');
                return rows;
            } catch (error) {
                addDebugLog(`Read sheet error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function writeSheet(sheetName, values, range = '') {
            if (dbConfig.isDemoMode) {
                addDebugLog(`Writing demo data to ${sheetName}: ${values.length} rows`);
                if (!demoData[sheetName]) demoData[sheetName] = [];
                if (range === 'A1:Z1') {
                    return { updatedRows: 1 };
                }
                demoData[sheetName].push(...values);
                return { updatedRows: values.length };
            }

            if (!dbConfig.isConnected) {
                throw new Error('Database tidak terhubung');
            }

            const fullRange = range ? `${sheetName}!${range}` : `${sheetName}!A:Z`;
            const url = `${SHEETS_API_BASE}/${dbConfig.spreadsheetId}/values/${encodeURIComponent(fullRange)}?valueInputOption=RAW&key=${dbConfig.apiKey}`;
            
            addDebugLog(`Writing to sheet: ${sheetName}, ${values.length} rows`);
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: values
                    })
                });

                addDebugLog(`Write response: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.error?.message || `Gagal menulis ke sheet: ${response.statusText}`;
                    addDebugLog(`Write error: ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                addDebugLog(`Successfully wrote to ${sheetName}`, 'success');
                return result;
            } catch (error) {
                addDebugLog(`Write sheet error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function appendSheet(sheetName, values) {
            if (dbConfig.isDemoMode) {
                addDebugLog(`Appending demo data to ${sheetName}: ${values.length} rows`);
                if (!demoData[sheetName]) demoData[sheetName] = [];
                demoData[sheetName].push(...values);
                return { updates: { updatedRows: values.length } };
            }

            if (!dbConfig.isConnected) {
                throw new Error('Database tidak terhubung');
            }

            const url = `${SHEETS_API_BASE}/${dbConfig.spreadsheetId}/values/${encodeURIComponent(sheetName)}:append?valueInputOption=RAW&key=${dbConfig.apiKey}`;
            
            addDebugLog(`Appending to sheet: ${sheetName}, ${values.length} rows`);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        values: values
                    })
                });

                addDebugLog(`Append response: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.error?.message || `Gagal menambah data ke sheet: ${response.statusText}`;
                    addDebugLog(`Append error: ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                addDebugLog(`Successfully appended to ${sheetName}`, 'success');
                return result;
            } catch (error) {
                addDebugLog(`Append sheet error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Sync Functions
        async function syncSheet(sheetName) {
            try {
                showLoading(`Menyinkronkan ${sheetName}...`);
                addDebugLog(`Starting sync for ${sheetName}`);
                
                const startTime = Date.now();
                const data = await readSheet(sheetName);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // Update sync status
                const syncStatus = document.getElementById(`${sheetName}SyncStatus`);
                if (syncStatus) {
                    syncStatus.textContent = `Sync: ${new Date().toLocaleTimeString()}`;
                }
                
                // Add to sync history
                syncHistory.unshift({
                    time: new Date().toISOString(),
                    sheet: sheetName,
                    status: 'Success',
                    records: data.length,
                    duration: duration,
                    error: null
                });
                
                // Keep only last 50 sync records
                if (syncHistory.length > 50) {
                    syncHistory = syncHistory.slice(0, 50);
                }
                
                updateSyncHistory();
                hideLoading();
                
                addDebugLog(`Sync completed for ${sheetName}: ${data.length} records in ${duration}ms`, 'success');
                showSuccess(`${sheetName} berhasil disinkronkan. ${data.length} record dimuat dalam ${duration}ms.`);
                
                // Refresh relevant data
                if (sheetName === 'income' || sheetName === 'expenses') {
                    loadDashboardData();
                }
                
                return data;
            } catch (error) {
                hideLoading();
                
                // Add error to sync history
                syncHistory.unshift({
                    time: new Date().toISOString(),
                    sheet: sheetName,
                    status: 'Error',
                    records: 0,
                    duration: 0,
                    error: error.message
                });
                
                updateSyncHistory();
                addDebugLog(`Sync failed for ${sheetName}: ${error.message}`, 'error');
                showError(`Gagal menyinkronkan ${sheetName}: ${error.message}`);
                throw error;
            }
        }

        async function syncAllSheets() {
            const sheets = Object.keys(REQUIRED_SHEETS);
            let successCount = 0;
            let errors = [];
            
            showLoading('Menyinkronkan semua sheet...');
            addDebugLog('Starting sync for all sheets');
            
            for (const sheet of sheets) {
                try {
                    await syncSheet(sheet);
                    successCount++;
                } catch (error) {
                    errors.push(`${sheet}: ${error.message}`);
                    addDebugLog(`Failed to sync ${sheet}: ${error.message}`, 'error');
                }
            }
            
            hideLoading();
            
            if (successCount === sheets.length) {
                addDebugLog(`All ${sheets.length} sheets synced successfully`, 'success');
                showSuccess(`Semua ${sheets.length} sheet berhasil disinkronkan!`);
            } else {
                const errorMsg = `${successCount}/${sheets.length} sheet berhasil disinkronkan.\n\nErrors:\n${errors.join('\n')}`;
                addDebugLog(`Partial sync success: ${successCount}/${sheets.length}`, 'warning');
                showError(errorMsg);
            }
        }

        function updateSyncHistory() {
            const tbody = document.getElementById('syncHistoryBody');
            if (!tbody) return;
            
            if (syncHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada riwayat sinkronisasi</td></tr>';
                return;
            }
            
            tbody.innerHTML = syncHistory.map(record => `
                <tr>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDateTime(record.time)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.sheet}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            record.status === 'Success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${record.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.records}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${record.error || '-'}</td>
                </tr>
            `).join('');
        }

        // Data Loading Functions
        async function loadDashboardData() {
            try {
                addDebugLog('Loading dashboard data');
                
                const [incomeData, expenseData, memberData, donationData] = await Promise.all([
                    readSheet('income').catch(() => []),
                    readSheet('expenses').catch(() => []),
                    readSheet('members').catch(() => []),
                    readSheet('donations').catch(() => [])
                ]);
                
                // Calculate totals
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                const monthlyIncome = incomeData
                    .filter(row => {
                        if (!row[0]) return false;
                        const date = new Date(row[0]);
                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => sum + (parseFloat(row[2]) || 0), 0);
                
                const monthlyExpense = expenseData
                    .filter(row => {
                        if (!row[0]) return false;
                        const date = new Date(row[0]);
                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => sum + (parseFloat(row[2]) || 0), 0);
                
                const totalIncome = incomeData.reduce((sum, row) => sum + (parseFloat(row[2]) || 0), 0);
                const totalExpense = expenseData.reduce((sum, row) => sum + (parseFloat(row[2]) || 0), 0);
                const totalDonations = donationData.reduce((sum, row) => sum + (parseFloat(row[4]) || 0), 0);
                const balance = totalIncome - totalExpense;
                
                const activeMembers = memberData.filter(row => row[5] === 'Active').length;
                const activeActivities = demoData.activities.filter(row => row[7] === 'Active').length;
                
                // Update dashboard
                const elements = {
                    'dashboardBalance': formatCurrency(balance),
                    'dashboardIncome': formatCurrency(monthlyIncome),
                    'dashboardExpense': formatCurrency(monthlyExpense),
                    'dashboardMembers': activeMembers,
                    'totalJamaah': activeMembers,
                    'totalDonations': formatCurrency(totalDonations),
                    'currentBalance': formatCurrency(balance),
                    'totalActivities': activeActivities
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
                
                // Update timestamps
                const now = new Date().toLocaleTimeString();
                ['balanceSheetUpdate', 'incomeSheetUpdate', 'expenseSheetUpdate', 'membersSheetUpdate',
                 'jamaahLastUpdate', 'donationsLastUpdate', 'balanceLastUpdate', 'activitiesLastUpdate'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = now;
                });
                
                addDebugLog('Dashboard data loaded successfully', 'success');
                
            } catch (error) {
                addDebugLog(`Error loading dashboard data: ${error.message}`, 'error');
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadIncomeData() {
            try {
                addDebugLog('Loading income data');
                const data = await readSheet('income');
                const tbody = document.getElementById('incomeTableBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Tidak ada data pemasukan</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((row, index) => `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[0] || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[1] || '-'}</td>
                        <td class="px-4 py-3 text-sm font-medium text-green-600">${formatCurrency(parseFloat(row[2]) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[3] || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                row[6] === 'Verified' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${row[6] || 'Pending'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                addDebugLog(`Loaded ${data.length} income records`, 'success');
                
            } catch (error) {
                addDebugLog(`Error loading income data: ${error.message}`, 'error');
                document.getElementById('incomeTableBody').innerHTML = 
                    '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Gagal memuat data pemasukan</td></tr>';
            }
        }

        async function loadExpenseData() {
            try {
                addDebugLog('Loading expense data');
                const data = await readSheet('expenses');
                const tbody = document.getElementById('expenseTableBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Tidak ada data pengeluaran</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((row, index) => `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[0] || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[1] || '-'}</td>
                        <td class="px-4 py-3 text-sm font-medium text-red-600">${formatCurrency(parseFloat(row[2]) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[3] || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                row[6] === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${row[6] || 'Pending'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                addDebugLog(`Loaded ${data.length} expense records`, 'success');
                
            } catch (error) {
                addDebugLog(`Error loading expense data: ${error.message}`, 'error');
                document.getElementById('expenseTableBody').innerHTML = 
                    '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Gagal memuat data pengeluaran</td></tr>';
            }
        }

        async function loadDonationsData() {
            try {
                addDebugLog('Loading donations data');
                const data = await readSheet('donations');
                const tbody = document.getElementById('donationsTableBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Tidak ada data donasi</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((row, index) => `
                    <tr>
                        <td class="px-4 py-3 text-sm font-mono text-gray-900">${row[0] || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[1] || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[3] || '-'}</td>
                        <td class="px-4 py-3 text-sm font-medium text-emerald-600">${formatCurrency(parseFloat(row[4]) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${row[6] || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                row[7] === 'Verified' ? 'bg-green-100 text-green-800' : 
                                row[7] === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'
                            }">
                                ${row[7] || 'Pending'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="verifyDonation('${row[0]}')" class="text-green-600 hover:text-green-800 mr-2" title="Verifikasi">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="viewDonationDetails('${row[0]}')" class="text-blue-600 hover:text-blue-800" title="Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                addDebugLog(`Loaded ${data.length} donation records`, 'success');
                
            } catch (error) {
                addDebugLog(`Error loading donations data: ${error.message}`, 'error');
                document.getElementById('donationsTableBody').innerHTML = 
                    '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Gagal memuat data donasi</td></tr>';
            }
        }

        async function loadActivitiesData() {
            try {
                addDebugLog('Loading activities data');
                const data = await readSheet('activities');
                const container = document.getElementById('activitiesList');
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Tidak ada kegiatan</div>';
                    return;
                }
                
                container.innerHTML = data.map(row => `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="h-48 bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-6xl text-white opacity-50"></i>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="px-3 py-1 bg-emerald-100 text-emerald-800 text-xs font-medium rounded-full">${row[6] || 'Kegiatan'}</span>
                                <span class="text-gray-500 text-sm">${row[2] || '-'}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${row[0] || 'Judul Kegiatan'}</h3>
                            <p class="text-gray-600 mb-4">${row[1] || 'Deskripsi kegiatan'}</p>
                            <div class="flex items-center justify-between text-sm text-gray-500">
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span>${row[3] || '-'}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${row[4]<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96fdc85663a4fe8e',t:'MTc1NTMxNDI4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
